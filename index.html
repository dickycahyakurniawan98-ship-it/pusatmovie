<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DICAKUN - Situs Streaming Film dan Serial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- === PERBAIKAN: OPEN GRAPH META TAGS (OG) === -->
    <!-- Ini adalah meta tag yang dibaca oleh Twitter/X, Facebook, dll. untuk membuat pratinjau -->
    <meta property="og:title" content="DICAKUN - Tonton Film & Serial Gratis Kualitas HD" />
    <meta property="og:description" content="Streaming film, serial, anime, dan donghua terbaru dengan akses link langsung. Nikmati koleksi lengkap tanpa batas." />
    <!-- GANTI DENGAN URL GAMBAR LOGO/POSTER BERKUALITAS TINGGI ANDA (Rasio ideal 1.91:1, misal 1200x628) -->
    <meta property="og:image" content="https://placehold.co/1200x630/dc2626/ffffff?text=DICAKUN+Streaming+Gratis" />
    <meta property="og:url" content="URL_ANDA_DI_SINI" />
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@NAMA_TWITTER_ANDA">
    <!-- ============================================== -->

    <style>
        /* Custom styles to ensure the video poster fits correctly */
        body { font-family: 'Inter', sans-serif; background-color: #0d1117; color: #e6e6e6; }
        .poster-container {
            position: relative;
            padding-top: 150%; /* 2:3 Aspect Ratio (or customize as needed) */
            overflow: hidden;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .poster-container:hover {
            transform: scale(1.02);
        }
        .poster-img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .video-wrapper {
            position: relative;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            border-radius: 0.5rem;
            overflow: hidden;
            background-color: #000;
        }

        .video-wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Iklan Overlay Transparan Penuh - SELALU 100% TRANSPARAN */
        .ad-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: transparent; 
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
        }
    </style>
</head>
<body>

<!-- Navbar (Tetap di atas) -->
<nav class="sticky top-0 z-50 bg-gray-900 shadow-xl">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
            <div class="flex items-center">
                <!-- Diperbaiki: Menggunakan navigateTo('home') untuk memastikan URL hash disetel ulang -->
                <a href="#" onclick="navigateTo('home')" class="flex-shrink-0 text-2xl font-extrabold text-red-500 tracking-wider">
                    DICAKUN
                </a>
                <div class="hidden md:block ml-10 flex space-x-4">
                    <button onclick="filterContent('Movie')" class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition duration-150">Movie</button>
                    <button onclick="filterContent('Series')" class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition duration-150">Serial</button>
                    <button onclick="filterContent('Donghua')" class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition duration-150">Donghua</button>
                    <button onclick="filterContent('Anime')" class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition duration-150">Anime</button>
                </div>
            </div>
            <div class="flex items-center">
                <div class="relative hidden sm:block">
                    <input type="text" id="search-input" placeholder="Cari..." class="bg-gray-800 text-white rounded-lg pl-4 pr-10 py-2 focus:ring-red-500 focus:border-red-500 transition duration-150">
                    <button onclick="performSearch()" class="absolute right-0 top-0 mt-2 mr-3 text-gray-400 hover:text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </button>
                </div>
                <!-- Mobile Menu Button (Hamburger) -->
                <button id="mobile-menu-button" type="button" class="ml-2 md:hidden bg-gray-800 inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white">
                    <svg class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Mobile Menu (Hidden by default) -->
    <div class="md:hidden hidden" id="mobile-menu">
        <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
            <input type="text" id="mobile-search-input" placeholder="Cari..." class="w-full bg-gray-800 text-white rounded-lg pl-4 pr-10 py-2 mb-2 focus:ring-red-500 focus:border-red-500 transition duration-150">
            <button onclick="performSearch(true)" class="block w-full text-white bg-red-600 hover:bg-red-700 px-3 py-2 rounded-md text-base font-medium transition duration-150">Cari</button>
            <button onclick="filterContent('Movie')" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Movie</button>
            <button onclick="filterContent('Series')" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Serial</button>
            <button onclick="filterContent('Donghua')" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Donghua</button>
            <button onclick="filterContent('Anime')" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Anime</button>
        </div>
    </div>
</nav>

<!-- Konten Utama (Beranda / Pemutar) -->
<main id="app-content" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"></main>

<!-- Modal for messages (instead of alert) -->
<div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-[100] flex items-center justify-center">
    <div class="bg-gray-800 p-6 rounded-lg shadow-2xl max-w-sm w-full">
        <h3 class="text-xl font-bold mb-3 text-red-500">Pesan</h3>
        <p id="message-text" class="text-gray-300 mb-4"></p>
        <button onclick="closeModal()" class="w-full bg-red-600 text-white py-2 rounded-md hover:bg-red-700 transition duration-150">Tutup</button>
    </div>
</div>

<script>
    // --- Variabel Global (Hanya untuk Cache dan Paginasi) ---
    let currentMovie = null; 
    let currentEpisode = 1;

    // PAGINATION STATE
    const PAGE_SIZE = 6;
    let latestPage = 1;
    let popularPage = 1;

    // Data dummy untuk Postingan
    const dummyData = [
        // --- MOVIE (Tidak perlu episodesData) ---
        { 
            id: 1, 
            title: 'Black Clover: Sword of the Wizard King', 
            type: 'Movie', 
            rating: 8.5, 
            views: 950000, 
            imageUrl: 'https://placehold.co/300x450/1e40af/ffffff?text=BC+Movie', 
            latestEpisode: null, 
            totalEpisodes: 1, 
            embed: { googleDrive: '1X3tCFGVxxxtYPLy40NMVYnJXnMHUA0eV' }, 
            downloadLink: 'link_download_movie_bc' 
        },
        // --- ANIME (Menggunakan episodesData) ---
        { 
            id: 2, 
            title: 'Attack on Titan Final Season', 
            type: 'Anime', 
            rating: 9.1, 
            views: 1200000, 
            imageUrl: 'https://placehold.co/300x450/6b7280/ffffff?text=AOT+Series', 
            latestEpisode: 2, 
            totalEpisodes: 28, 
            episodesData: [
                { episode: 1, embed: { youtube: 'ID_YOUTUBE_AOT_EP1' } },
                { episode: 2, embed: { dailymotion: 'ID_DAILYMOTION_AOT_EP2' } },
            ],
            downloadLink: 'link_download_series_aot' 
        },
        // --- DONGHUA (Menggunakan episodesData) ---
        { 
            id: 3, 
            title: 'Battle Through the Heavens S5', 
            type: 'Donghua', 
            rating: 8.8, 
            views: 750000, 
            imageUrl: 'https://placehold.co/300x450/dc2626/ffffff?text=BTTH+S5', 
            latestEpisode: 5, 
            totalEpisodes: 52, 
            episodesData: [
                { episode: 1, embed: { youtube: 'ID_YOUTUBE_BTTH_EP1' } },
                { episode: 2, embed: { youtube: 'ID_YOUTUBE_BTTH_EP2' } },
                { episode: 3, embed: { youtube: 'ID_YOUTUBE_BTTH_EP3' } },
                { episode: 4, embed: { youtube: 'ID_YOUTUBE_BTTH_EP4' } },
                { episode: 5, embed: { youtube: 'ID_YOUTUBE_BTTH_EP5' } },
            ],
            downloadLink: 'link_download_donghua_btth' 
        },
        // --- SERIES (Menggunakan episodesData) ---
        { 
            id: 4, 
            title: 'The Witcher', 
            type: 'Series', 
            rating: 8.2, 
            views: 1100000, 
            imageUrl: 'https://placehold.co/300x450/065f46/ffffff?text=The+Witcher', 
            latestEpisode: 8, 
            totalEpisodes: 8, 
            episodesData: [
                { episode: 1, embed: { youtube: 'gC4gnTy6l9c' } },
                { episode: 2, embed: { youtube: 'gC4gnTy6l9c' } }, 
                { episode: 8, embed: { youtube: 'gC4gnTy6l9c' } },
            ],
            downloadLink: 'link_download_series_witcher' 
        },
        // --- MOVIE ---
        { 
            id: 5, 
            title: 'Spider-Man: No Way Home', 
            type: 'Movie', 
            rating: 7.8, 
            views: 500000, 
            imageUrl: 'https://placehold.co/300x450/1e3a8a/ffffff?text=Spider-Man', 
            latestEpisode: null, 
            totalEpisodes: 1, 
            embed: { youtube: 'JfVOs4VSpmA' }, 
            downloadLink: 'link_download_movie_spiderman' 
        },
        // --- ANIME ---
        { 
            id: 6, 
            title: 'Jujutsu Kaisen Season 2', 
            type: 'Anime', 
            rating: 9.0, 
            views: 850000, 
            imageUrl: 'https://placehold.co/300x450/f97316/ffffff?text=JJK+S2', 
            latestEpisode: 1, 
            totalEpisodes: 24, 
            episodesData: [
                { episode: 1, embed: { dailymotion: 'x8f1t0p' } },
            ],
            downloadLink: 'link_download_series_jjk' 
        },
        // Tambahkan beberapa dummy lagi untuk demonstrasi paginasi
        { id: 7, title: 'Extra Post 1', type: 'Movie', rating: 7.0, views: 300000, imageUrl: 'https://placehold.co/300x450/333333/ffffff?text=Extra+1', latestEpisode: null, totalEpisodes: 1, embed: { youtube: 'gC4gnTy6l9c' }, downloadLink: '' },
        { id: 8, title: 'Extra Post 2', type: 'Series', rating: 7.5, views: 150000, imageUrl: 'https://placehold.co/300x450/444444/ffffff?text=Extra+2', latestEpisode: 3, totalEpisodes: 10, episodesData: [], downloadLink: '' },
        { id: 9, title: 'Extra Post 3', type: 'Donghua', rating: 6.8, views: 700000, imageUrl: 'https://placehold.co/300x450/555555/ffffff?text=Extra+3', latestEpisode: 1, totalEpisodes: 1, episodesData: [], downloadLink: '' },
        { id: 10, title: 'Extra Post 4', type: 'Anime', rating: 9.5, views: 1000000, imageUrl: 'https://placehold.co/300x450/666666/ffffff?text=Extra+4', latestEpisode: 10, totalEpisodes: 10, episodesData: [], downloadLink: '' },
        { id: 11, title: 'Extra Post 5', type: 'Movie', rating: 8.1, views: 400000, imageUrl: 'https://placehold.co/300x450/777777/ffffff?text=Extra+5', latestEpisode: null, totalEpisodes: 1, embed: { youtube: 'gC4gnTy6l9c' }, downloadLink: '' },
        { id: 12, title: 'Extra Post 6', type: 'Series', rating: 7.9, views: 200000, imageUrl: 'https://placehold.co/300x450/888888/ffffff?text=Extra+6', latestEpisode: 2, totalEpisodes: 5, episodesData: [], downloadLink: '' },
        { id: 13, title: 'Extra Post 7', type: 'Donghua', rating: 9.2, views: 600000, imageUrl: 'https://placehold.co/300x450/999999/ffffff?text=Extra+7', latestEpisode: 4, totalEpisodes: 4, episodesData: [], downloadLink: '' },
    ];
    
    // --- Fungsi Utilitas Navigasi Berbasis URL ---

    function showModal(message) {
        document.getElementById('message-text').textContent = message;
        document.getElementById('message-modal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('message-modal').classList.add('hidden');
    }

    function getMovieById(id) {
        return dummyData.find(m => m.id === id);
    }
    
    // Diperbaiki: Fungsi untuk membaca parameter dari URL Hash (#)
    function getUrlParams() {
        const hash = window.location.hash.substring(1); // Ambil hash tanpa karakter '#'
        const params = new URLSearchParams(hash);
        return {
            view: params.get('view') || 'home',
            id: parseInt(params.get('id')),
            episode: parseInt(params.get('ep') || '1')
        };
    }

    // Diperbaiki: Fungsi Navigasi yang Mengubah URL Hash (lebih aman di sandbox)
    function navigateTo(view, id = null, episode = 1) {
        let newHash = `view=${view}`;
        if (id) {
            newHash += `&id=${id}&ep=${episode}`;
        }
        
        // Mengubah hash (tidak memicu SecurityError)
        window.location.hash = newHash;
        
        // Memanggil renderApp secara eksplisit untuk menjamin rendering langsung
        renderApp();
        window.scrollTo(0, 0); 
    }

    // Render komponen Poster Film
    function renderPostCard(movie) {
        const episodeInfo = (movie.type !== 'Movie' && movie.latestEpisode) ? `Ep ${movie.latestEpisode}` : '';
        
        const typeColor = {
            Movie: 'bg-red-600',
            Series: 'bg-blue-600',
            Donghua: 'bg-green-600',
            Anime: 'bg-purple-600'
        }[movie.type] || 'bg-gray-600';

        // Panggil navigateTo dengan view='player' untuk memuat halaman pemutar unik
        return `
            <div class="rounded-lg overflow-hidden cursor-pointer" onclick="navigateTo('player', ${movie.id}, ${movie.latestEpisode || 1})">
                <div class="poster-container">
                    <img src="${movie.imageUrl}" alt="Poster ${movie.title}" class="poster-img">
                    
                    <!-- Overlay Rating (Kanan Atas) -->
                    <div class="absolute top-2 right-2 bg-yellow-500 text-gray-900 text-xs font-bold px-2 py-0.5 rounded-md shadow-lg">
                        ‚≠ê ${movie.rating}
                    </div>

                    <!-- Overlay Type dan Episode (Kanan Bawah) -->
                    <div class="absolute bottom-0 right-0 p-2 space-y-1 text-right">
                        <span class="inline-block ${typeColor} text-white text-xs font-semibold px-2 py-0.5 rounded-full shadow-lg">
                            ${movie.type}
                        </span>
                        ${episodeInfo ? `<span class="inline-block bg-gray-900 text-white text-xs font-semibold px-2 py-0.5 rounded-full shadow-lg">${episodeInfo}</span>` : ''}
                    </div>
                </div>
                <h3 class="text-white text-md font-semibold mt-2 truncate">${movie.title}</h3>
                <p class="text-gray-400 text-sm">${movie.type}</p>
            </div>
        `;
    }

    // Fungsi untuk merender kontrol Paginasi (Prev/Next)
    function renderPaginationControls(sectionName, currentPage, totalPages) {
        if (totalPages <= 1) return '';
        
        return `
            <div class="flex justify-center space-x-4 mt-8">
                <button onclick="changePage('${sectionName}', 'prev')" 
                        ${currentPage === 1 ? 'disabled' : ''} 
                        class="px-4 py-2 bg-gray-700 text-white rounded-lg font-semibold hover:bg-gray-600 disabled:opacity-50 transition duration-150">
                    Prev
                </button>
                <span class="px-4 py-2 text-gray-300 font-medium hidden sm:block">
                    Halaman ${currentPage} / ${totalPages}
                </span>
                <button onclick="changePage('${sectionName}', 'next')" 
                        ${currentPage === totalPages ? 'disabled' : ''} 
                        class="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 disabled:opacity-50 transition duration-150">
                    Next
                </button>
            </div>
        `;
    }

    // Fungsi untuk mengubah halaman paginasi
    function changePage(section, direction) {
        if (section === 'popular') {
            if (direction === 'next') popularPage++; else popularPage--;
        } else if (section === 'latest') {
            if (direction === 'next') latestPage++; else latestPage--;
        }
        renderHome(); // Re-render home page dengan status halaman baru
        window.scrollTo(0, 0); // Gulir ke atas
    }


    // --- Fungsi Halaman Utama (Home) ---

    function renderHome(data = dummyData) {
        const contentDiv = document.getElementById('app-content');
        let html = '';
        
        const isFiltered = data !== dummyData;
        const totalItems = data.length;
        
        // --- 1. Postingan Populer (Prioritas di Tampilan Seluler) ---
        const sortedPopular = [...data].sort((a, b) => {
            if (b.views !== a.views) {
                return b.views - a.views;
            }
            return b.rating - a.rating;
        });
        
        const popularTotalPages = isFiltered ? 1 : Math.ceil(totalItems / PAGE_SIZE);
        const popularStartIndex = (popularPage - 1) * PAGE_SIZE;
        const popularEndIndex = popularStartIndex + PAGE_SIZE;
        const popularPosts = sortedPopular.slice(popularStartIndex, popularEndIndex);

        html += `
            <section id="popular-section" class="mb-10">
                <h2 class="text-3xl font-bold text-white mb-6 border-b border-red-600 pb-2">Postingan Populer</h2>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    ${popularPosts.map(renderPostCard).join('')}
                </div>
                ${!isFiltered ? renderPaginationControls('popular', popularPage, popularTotalPages) : ''}
            </section>
        `;

        // --- 2. Postingan Terbaru ---
        
        if (!isFiltered) { 
            const sortedLatest = [...data].sort((a, b) => b.id - a.id);
            
            const latestTotalPages = Math.ceil(totalItems / PAGE_SIZE);
            const latestStartIndex = (latestPage - 1) * PAGE_SIZE;
            const latestEndIndex = latestStartIndex + PAGE_SIZE;
            const latestPosts = sortedLatest.slice(latestStartIndex, latestEndIndex);
            
            html += `
                <section id="latest-section" class="mb-10">
                    <h2 class="text-3xl font-bold text-white mb-6 border-b border-red-600 pb-2">Postingan Terbaru</h2>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                        ${latestPosts.map(renderPostCard).join('')}
                    </div>
                    ${renderPaginationControls('latest', latestPage, latestTotalPages)}
                </section>
            `;
        }

        contentDiv.innerHTML = html;
        // Pastikan menu mobile ditutup setelah navigasi di halaman utama
        document.getElementById('mobile-menu').classList.add('hidden');
    }

    // Fungsi Filter Konten
    function filterContent(type) {
        latestPage = 1; 
        popularPage = 1;
        
        const filteredData = dummyData.filter(m => m.type === type);
        if (filteredData.length === 0) {
            showModal(`Tidak ada konten untuk kategori: ${type}. Menampilkan semua postingan.`);
            renderHome(dummyData);
            return;
        }
        renderHome(filteredData);
    }

    // Fungsi Pencarian
    function performSearch(isMobile = false) {
        latestPage = 1; 
        popularPage = 1;
        
        const inputId = isMobile ? 'mobile-search-input' : 'search-input';
        const query = document.getElementById(inputId).value.toLowerCase();
        if (!query) {
            showModal("Mohon masukkan kata kunci pencarian.");
            return;
        }

        const searchResults = dummyData.filter(movie => 
            movie.title.toLowerCase().includes(query) || movie.type.toLowerCase().includes(query)
        );

        if (searchResults.length > 0) {
            renderHome(searchResults);
        } else {
            showModal(`Tidak ditemukan hasil untuk "${query}".`);
            renderHome(dummyData);
        }
        document.getElementById(inputId).value = '';
        document.getElementById('mobile-menu').classList.add('hidden');
    }

    // --- Fungsi Halaman Pemutar (Player) ---

    // FUNGSI INI MENCARI EMBED SPESIFIK BERDASARKAN NOMOR EPISODE
    function getEmbed(movie, episode) {
        let embedKey = '';
        let embedId = '';
        
        // 1. Cek apakah ini Movie (menggunakan embed tunggal)
        if (movie.type === 'Movie' || !movie.episodesData) {
            if (movie.embed) {
                embedKey = Object.keys(movie.embed)[0];
                embedId = movie.embed[embedKey];
            } else {
                 return { url: '', type: 'Tidak Ditemukan', message: 'Tautan embed film tidak ditemukan.' };
            }
        } 
        // 2. Cek apakah ini Serial/Anime/Donghua (menggunakan episodesData)
        else {
            const episodeData = movie.episodesData.find(e => e.episode === episode);
            
            if (episodeData && episodeData.embed) {
                embedKey = Object.keys(episodeData.embed)[0];
                embedId = episodeData.embed[embedKey];
            } else {
                return { url: '', type: 'Tidak Ditemukan', message: `Tautan embed untuk Episode ${episode} belum tersedia.` };
            }
        }

        // 3. Konversi ID Embed menjadi URL Iframe
        switch (embedKey) {
            case 'youtube':
                return { url: `https://www.youtube.com/embed/${embedId}?autoplay=0`, type: 'YouTube', message: null };
            case 'dailymotion':
                return { url: `https://www.dailymotion.com/embed/video/${embedId}`, type: 'Dailymotion', message: null };
            case 'googleDrive':
                return { url: `https://drive.google.com/file/d/${embedId}/preview`, type: 'Google Drive', message: null };
            default:
                return { url: '', type: 'Tidak Ditemukan', message: 'Tipe embed tidak didukung.' };
        }
    }

    function renderPlayer() {
        const contentDiv = document.getElementById('app-content');
        if (!currentMovie) {
            // Jika data film hilang (misal, ID di URL salah), kembali ke beranda
            navigateTo('home');
            return;
        }

        const isSeries = currentMovie.type !== 'Movie';
        const embedInfo = getEmbed(currentMovie, currentEpisode);
        
        // Cek Batasan Episode
        const hasPrev = currentEpisode > 1;
        const totalEps = currentMovie.totalEpisodes || 1;
        const hasNext = isSeries && totalEps > 1 && currentEpisode < totalEps;
        
        let playerContent = '';

        if (embedInfo.url) {
            // Jika embed ditemukan
             playerContent = `
                <!-- Lapisan Transparan / Ad Layer -->
                <!-- GANTI LINK BERIKUT DENGAN DIRECT LINK ADSTERRA ANDA -->
                <a href="PASANG_LINK_DIRECT_ADSTERRA_ANDA_DI_SINI" target="_blank" class="ad-overlay" id="ad-overlay-link" title="Klik untuk lanjut ke video">
                    <div class="w-full h-full"></div>
                </a>
                <iframe id="video-embed" allowfullscreen></iframe>
            `;
        } else {
            // Jika embed TIDAK ditemukan (misalnya: Episode belum di-upload)
            playerContent = `
                <div class="flex items-center justify-center h-full bg-gray-900 rounded-lg text-red-500">
                    <p class="p-8 text-lg font-semibold">${embedInfo.message || 'Error: Konten pemutar tidak dapat dimuat.'}</p>
                </div>
            `;
        }


        let html = `
            <h1 class="text-3xl md:text-4xl font-extrabold text-white mb-4">
                <button onclick="navigateTo('home')" class="text-gray-400 hover:text-red-500 mr-2">&larr;</button>
                ${currentMovie.title} ${isSeries ? `(Episode ${currentEpisode})` : ''}
            </h1>
            
            <!-- Frame Video dan Lapisan Transparan (Ad Overlay) -->
            <div class="video-wrapper mb-6">
                ${playerContent}
            </div>

            <!-- Tombol Download dan Navigasi Episode -->
            <div class="bg-gray-800 p-4 rounded-lg shadow-xl mb-8">
                <div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
                    <!-- Tombol Download -->
                    <a href="${currentMovie.downloadLink}" target="_blank" class="w-full md:w-auto px-6 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition duration-150 text-center">
                        <svg class="w-5 h-5 inline mr-2 -mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Download Film
                    </a>
                    
                    ${isSeries && totalEps > 1 ? `
                    <!-- Navigasi Episode -->
                    <div class="flex space-x-3 w-full md:w-auto">
                        <button onclick="changeEpisode('prev')" ${hasPrev ? '' : 'disabled'} class="flex-1 px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 disabled:opacity-50 transition duration-150">
                            Prev
                        </button>
                        <span class="px-4 py-2 bg-gray-700 text-white font-bold rounded-lg whitespace-nowrap">
                            Episode ${currentEpisode} / ${totalEps}
                        </span>
                        <button onclick="changeEpisode('next')" ${hasNext ? '' : 'disabled'} class="flex-1 px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 disabled:opacity-50 transition duration-150">
                            Next
                        </button>
                    </div>
                    ` : ''}
                </div>
            </div>
            
            <!-- Rekomendasi Movie Sesuai Type -->
            <section>
                <h2 class="text-2xl font-bold text-white mb-4 border-b border-red-600 pb-2">Rekomendasi ${currentMovie.type}</h2>
                <div id="recommendation-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                    <!-- Konten rekomendasi dimuat di JS -->
                </div>
            </section>
        `;

        contentDiv.innerHTML = html;
        
        loadVideoAndRecommendations();
    }

    function loadVideoAndRecommendations() {
        const embedInfo = getEmbed(currentMovie, currentEpisode);
        const iframe = document.getElementById('video-embed');
        const overlay = document.getElementById('ad-overlay-link');

        // Logic untuk overlay: Saat overlay diklik, sembunyikan dan muat video
        if (overlay && iframe && embedInfo.url) {
            overlay.classList.remove('hidden');

            overlay.onclick = (e) => {
                e.preventDefault(); 
                
                window.open(overlay.href, '_blank'); 
                
                overlay.style.display = 'none';
                iframe.src = embedInfo.url;
                
                return false;
            };
        } else if (overlay) {
             overlay.classList.add('hidden');
        }


        // Rekomendasi
        const recommendations = dummyData.filter(m => m.type === currentMovie.type && m.id !== currentMovie.id);
        const recGrid = document.getElementById('recommendation-grid');
        if (recGrid) {
            recGrid.innerHTML = recommendations.slice(0, 5).map(renderPostCard).join('');
            
            if (recommendations.length === 0 && recGrid.previousElementSibling) {
                 recGrid.parentElement.classList.add('hidden');
            } else if (recGrid.parentElement) {
                recGrid.parentElement.classList.remove('hidden');
            }
        }
    }

    function changeEpisode(direction) {
        let newEpisode = currentEpisode;
        if (direction === 'next') {
            newEpisode++;
        } else if (direction === 'prev') {
            newEpisode--;
        }

        const totalEps = currentMovie.totalEpisodes || 1;
        if (newEpisode >= 1 && newEpisode <= totalEps) {
            // Panggil navigateTo untuk mengubah URL hash dan merender ulang halaman
            navigateTo('player', currentMovie.id, newEpisode);
        } else {
            showModal("Tidak ada episode selanjutnya atau sebelumnya.");
        }
    }

    // --- Inisialisasi Aplikasi ---

    function renderApp() {
        const params = getUrlParams();
        const movie = getMovieById(params.id);

        // Update state global berdasarkan URL parameter yang baru dibaca
        currentMovie = movie;
        currentEpisode = params.episode;

        if (params.view === 'player' && movie) {
            renderPlayer();
        } else {
            renderHome();
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        
        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });
        
        // Diperbaiki: Mengganti 'popstate' dengan 'hashchange' untuk menghindari SecurityError
        window.addEventListener('hashchange', renderApp);

        // Render halaman awal (Membaca URL saat dimuat)
        renderApp(); 
    });
</script>

</body>
</html>

